<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Love Tank</title>
  <link rel="manifest" href="/love-tank/manifest.json">
  <style>
    :root {
      /* Soft Classic Theme */
      --background-color: #fcebeb;
      --card-background: #fff;
      --heading-color: #4b3636;
      --tank-background: #e8dada;
      --khaled-color: #79a3b1;
      --manna-color: #c48c9c;
      --text-color: #000;
      --accent-color: var(--manna-color);
      --button-text-color: #fff;
      --header-button-bg: var(--accent-color);
      --header-button-text: var(--button-text-color);
      --section-emoji: 'ü§é';
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: var(--background-color);
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      transition: background 0.5s ease;
      color: var(--text-color);
    }
    .main-app {
      display: none;
      width: 100%;
    }
    .login-page {
      display: none;
      width: 100%;
      max-width: 400px;
      text-align: center;
    }
    .login-container {
      background: var(--card-background);
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: var(--heading-color);
    }
    h3 {
      text-align: center;
      color: var(--heading-color);
    }
    .input-group {
      margin-bottom: 15px;
      text-align: left;
    }
    .input-group input {
      width: 95%;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    .button-group {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
    }
    .tanks {
      display: flex;
      justify-content: space-between;
      gap: 20px;
      margin: 20px 0;
    }
    .tank {
      flex: 1;
      text-align: center;
      padding: 10px;
      border-radius: 10px;
      background: var(--tank-background);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .progress {
      width: 100%;
      height: 30px;
      border-radius: 5px;
      background: #ddd;
      margin: 10px 0;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      width: 0%;
      transition: width 0.3s;
    }
    .khaled .progress-fill {
      background: var(--khaled-color);
    }
    .manna .progress-fill {
      background: var(--manna-color);
    }
    .tank button {
      margin: 5px;
      padding: 5px 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .header {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
      width: 100%;
    }
    .header button {
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background-color: var(--header-button-bg);
      color: var(--header-button-text);
    }
    .header button:hover {
      opacity: 0.8;
    }
    .section {
      margin: 20px 0;
      padding: 15px;
      background: var(--card-background);
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: relative;
      z-index: 1;
    }
    .section h3 {
      text-align: center;
      position: relative;
    }
    .section h3::before {
      content: var(--section-emoji);
      margin-right: 10px;
    }
    .section h3::after {
      content: var(--section-emoji);
      margin-left: 10px;
    }
    .input-container {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    .input-container input {
      flex: 1;
      margin: 0;
    }
    .input-container button {
      margin: 0;
    }
    input, textarea {
      width: 100%;
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      padding: 5px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #eee;
    }
    li:last-child {
      border-bottom: none;
    }
    li small {
      color: gray;
      margin-left: 10px;
    }
    .actions {
      display: flex;
      gap: 5px;
    }
    .actions button {
      font-size: 1.2em;
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .checkbox-item span.done {
      text-decoration: line-through;
    }
    .section-footer {
      display: flex;
      justify-content: flex-end;
      margin-top: 10px;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.4);
      padding-top: 60px;
    }
    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 400px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .modal-content h3 {
      margin-top: 0;
      color: #000;
    }
    .modal-content label {
      color: #000;
    }
    .modal-content input {
      margin-bottom: 10px;
    }
    .modal-buttons {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
    }
    .modal-buttons .right {
      display: flex;
      gap: 10px;
    }
    .delete-account-btn {
      background-color: #f44336;
      color: white;
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .delete-account-btn:hover {
      opacity: 0.8;
    }
    #loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--background-color);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 999;
      font-size: 1.5em;
      color: var(--manna-color);
      text-align: center;
      transition: background 0.5s ease, color 0.5s ease;
    }
    .loading-content {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .spinner {
      border: 4hpx solid rgba(179, 0, 89, 0.1);
      border-top: 4px solid var(--manna-color);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin-top: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* New Themes */
    .theme-classic {
      --background-color: #fcebeb;
      --card-background: #fff;
      --heading-color: #4b3636;
      --tank-background: #e8dada;
      --khaled-color: #79a3b1;
      --manna-color: #c48c9c;
      --text-color: #000;
      --accent-color: var(--manna-color);
      --button-text-color: #fff;
      --header-button-bg: var(--accent-color);
      --header-button-text: var(--button-text-color);
      --section-emoji: 'ü§ç';
      --heart-color: #e6b3c0;
    }
    .theme-midnight {
      --background-color: #0D1B2A;
      --card-background: #3B4E6B;
      --heading-color: #CFD8DC;
      --tank-background: #3B4E6B;
      --khaled-color: #4B0082;
      --manna-color: #1034A6;
      --text-color: #CFD8DC;
      --accent-color: #5B428A;
      --header-button-bg: #5B428A;
      --header-button-text: #fff;
      --heart-color: #CFD8DC;
      --section-emoji: 'ü§ç';
    }
    .theme-sunset {
      --background-color: #F8BBD0;
      --card-background: #FFF8DC;
      --heading-color: #6A0000;
      --tank-background: #E9967A;
      --khaled-color: #DAA520;
      --manna-color: #DC143C;
      --text-color: #000;
      --accent-color: #DC143C;
      --header-button-bg: #5B428A;
      --header-button-text: #fff;
      --heart-color: #FFA500;
      --section-emoji: 'üß°';
      background-image: linear-gradient(to top, #FF4500 0%, #FFD700 30%, #FFB6C1 60%, #8A2BE2 100%);
    }
    .theme-forest {
      --background-color: #D1E2D1;
      --card-background: #F1F7F1;
      --heading-color: #214321;
      --tank-background: #A9C6A9;
      --khaled-color: #78909C;
      --manna-color: #466C46;
      --text-color: #000;
      --accent-color: #466C46;
      --header-button-bg: #78909C;
      --header-button-text: #fff;
      --heart-color: #5d4037;
      --section-emoji: 'ü§é';
    }
    
    /* Normal Theme Button Styling */
    .theme-classic .section button,
    .theme-classic .input-container button,
    .theme-classic .section-footer button,
    .theme-classic .actions button:not(.liked) {
        background-color: var(--manna-color);
        color: var(--button-text-color);
    }
    .theme-midnight .section button,
    .theme-midnight .input-container button,
    .theme-midnight .section-footer button,
    .theme-midnight .actions button:not(.liked) {
        background-color: var(--accent-color);
        color: var(--button-text-color);
    }
    .theme-sunset .section button,
    .theme-sunset .input-container button,
    .theme-sunset .section-footer button,
    .theme-sunset .actions button:not(.liked) {
        background-color: var(--accent-color);
        color: var(--button-text-color);
    }
    .theme-forest .section button,
    .theme-forest .input-container button,
    .theme-forest .section-footer button,
    .theme-forest .actions button:not(.liked) {
        background-color: var(--khaled-color);
        color: var(--button-text-color);
    }

    .theme-classic .actions button.liked,
    .theme-midnight .actions button.liked,
    .theme-sunset .actions button.liked,
    .theme-forest .actions button.liked {
        color: var(--heart-color);
    }

    /* Modal Button Styling for Normal Themes */
    .theme-classic .modal-buttons button {
        background-color: var(--manna-color);
        color: var(--button-text-color);
    }
    .theme-midnight .modal-buttons button {
        background-color: var(--accent-color);
        color: var(--button-text-color);
    }
    .theme-sunset .modal-buttons button {
        background-color: var(--accent-color);
        color: var(--button-text-color);
    }
    .theme-forest .modal-buttons button {
        background-color: var(--khaled-color);
        color: var(--button-text-color);
    }


    /* Superhero Themes */
    .theme-batman-signal {
      --background-color: #000;
      --card-background: #4A4A4A;
      --heading-color: #fff;
      --tank-background: #4A4A4A;
      --khaled-color: #FFD700;
      --manna-color: #FFD700;
      --text-color: #fff;
      --accent-color: #FFD700;
      --header-button-bg: var(--accent-color);
      --header-button-text: #000;
      --heart-color: #000000;
      --section-emoji: 'ü¶á';
      background: radial-gradient(circle at 50% 10%, rgba(255,215,0,0.5), transparent 60%);
    }
    .theme-batman-signal .tank button, .theme-batman-signal .section button {
        background-color: var(--accent-color);
        color: #000;
    }
    .theme-batman-signal .modal-buttons button {
        background-color: var(--accent-color);
        color: #000;
    }
    .theme-batman-signal .tank h3 {
        color: var(--text-color);
    }
    .theme-batman-signal .section h3 {
        color: var(--text-color);
    }
    .theme-spiderman {
      --background-color: #00008B;
      --card-background: #cccccc;
      --heading-color: #fff;
      --tank-background: rgba(255, 255, 255, 0.1);
      --khaled-color: #FF0000;
      --manna-color: #FF0000;
      --text-color: #000;
      --accent-color: #FF0000;
      --header-button-bg: var(--accent-color);
      --header-button-text: #fff;
      --heart-color: red;
      --section-emoji: 'üï∑Ô∏è';
      background-image: repeating-linear-gradient(
        -45deg,
        rgba(255,0,0,0.1) 0px,
        rgba(255,0,0,0.1) 2px,
        transparent 2px,
        transparent 10px
      );
    }
    .theme-spiderman h1, .theme-spiderman .tank h3 {
        color: #fff;
    }
    .theme-spiderman .tank button, .theme-spiderman .section button {
        background-color: var(--accent-color);
        color: #fff;
    }
    .theme-spiderman .modal-buttons button {
        background-color: var(--accent-color);
        color: #fff;
    }
    .theme-spiderman .section h3, .theme-spiderman .section ul li, .theme-spiderman .section ul li small {
      color: #000;
    }
    .theme-hulk {
      --background-color: #0C1E0C;
      --card-background: #286C28;
      --heading-color: #fff;
      --tank-background: #286C28;
      --khaled-color: #9E9E9E;
      --manna-color: #9E9E9E;
      --text-color: #fff;
      --accent-color: #286C28;
      --header-button-bg: #9E9E9E;
      --header-button-text: #fff;
      --heart-color: green;
      --section-emoji: 'üßü';
      background: #0C1E0C;
    }
    .theme-hulk::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: linear-gradient(
        45deg, #153815 25%, transparent 25%, transparent 75%, #153815 75%, #153815
      ), linear-gradient(
        45deg, #153815 25%, transparent 25%, transparent 75%, #153815 75%, #153815
      );
      background-size: 50px 50px;
      opacity: 0.2;
      z-index: -1;
    }
    .theme-hulk .tank button, .theme-hulk .section button {
        background-color: var(--header-button-bg);
        color: #fff;
    }
    .theme-hulk .modal-buttons button {
        background-color: #9E9E9E;
        color: #fff;
    }
    .theme-hulk .tank h3 {
        color: var(--text-color);
    }
    .theme-hulk .section h3 {
        color: var(--text-color);
    }
    .theme-wolverine {
      --background-color: #FDDA0D;
      --card-background: #192D6A;
      --heading-color: #000000;
      --tank-background: #192D6A;
      --khaled-color: #87CEEB; /* Sky blue */
      --manna-color: #87CEEB; /* Sky blue */
      --text-color: #FFFFFF;
      --accent-color: #192D6A; /* Dark blue for header buttons */
      --button-color: #36454F; /* Charcoal Gray for inner buttons */
      --button-text-color: #FFFFFF;
      --header-button-bg: var(--accent-color);
      --header-button-text: var(--button-text-color);
      --heart-color: yellow;
      --section-emoji: '‚öîÔ∏è';
      background: #FDDA0D;
    }
    .theme-wolverine::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: repeating-linear-gradient(
        -45deg,
        rgba(0,0,0,0.1) 0px,
        rgba(0,0,0,0.1) 1px,
        transparent 1px,
        transparent 10px
      );
      z-index: -1;
    }
    .theme-wolverine h1 {
        color: var(--heading-color);
    }
    .theme-wolverine .tank h3 {
        color: var(--text-color);
    }
    .theme-wolverine .section h3 {
        color: var(--text-color);
    }
    .theme-wolverine .tank button, .theme-wolverine .section button {
        background-color: var(--button-color);
        color: var(--button-text-color);
    }
    .theme-wolverine .input-container button, .theme-wolverine .section-footer button {
        background-color: var(--button-color);
        color: var(--button-text-color);
    }
    .theme-wolverine .modal-content {
      background-color: #fff;
    }
    .theme-wolverine .modal-content h3, .theme-wolverine .modal-content label {
      color: #000;
    }
    .theme-wolverine .modal-content input {
      background-color: #D3D3D3;
      color: #000;
      border: 1px solid #000;
    }
    .theme-wolverine .modal-buttons button {
        background-color: var(--accent-color);
        color: var(--button-text-color);
    }
    .theme-wolverine .delete-account-btn {
        background-color: var(--accent-color);
        color: var(--button-text-color);
    }
    .theme-wolverine .header button {
        background-color: var(--accent-color);
        color: var(--header-button-text);
    }
    .theme-wolverine .actions button {
        background-color: transparent;
        color: var(--text-color);
    }
    button {
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      opacity: 0.8;
    }
    .section ul li {
      color: var(--text-color);
    }
    .section ul li small {
      color: var(--text-color);
      opacity: 0.8;
    }
    .actions button.liked {
      color: var(--heart-color);
    }
  </style>
</head>
<body>
  <div id="loading">
    <div class="loading-content">
      <p>Connecting Hearts...</p>
      <div class="spinner"></div>
    </div>
  </div>

  <div id="login-page">
    <div class="login-container">
      <h1>Couple Login</h1>
      <div class="input-group">
        <label for="username">Couple Username</label>
        <input type="text" id="username">
      </div>
      <div class="input-group">
        <label for="password">Couple Password</label>
        <input type="password" id="password" placeholder="Minimum 6 characters">
      </div>
      <div class="button-group">
        <button onclick="signUp()">Sign Up</button>
        <button onclick="logIn()">Log In</button>
      </div>
    </div>
  </div>

  <div id="main-app">
    <div class="header">
      <div style="display: flex; gap: 10px;">
        <button onclick="openSettings()">Account Settings</button>
        <button onclick="openThemes()">Themes</button>
        <button onclick="logOut()">Log Out</button>
      </div>
    </div>
    
    <h1 style="text-align: center;"><span id="khaled-name-display"></span> and <span id="manna-name-display"></span> Space</h1>
    
    <div class="tanks">
      <div class="tank khaled">
        <h3 id="khaled-tank-heading">His Tank</h3>
        <div class="progress"><div class="progress-fill" id="khaled-fill"></div></div>
        <button onclick="updateTank('khaled', -20)">-</button>
        <button onclick="updateTank('khaled', 20)">+</button>
      </div>
      <div class="tank manna">
        <h3 id="manna-tank-heading">Her Tank</h3>
        <div class="progress"><div class="progress-fill" id="manna-fill"></div></div>
        <button onclick="updateTank('manna', -20)">-</button>
        <button onclick="updateTank('manna', 20)">+</button>
      </div>
    </div>
    
    <div class="section">
      <h3>Notes</h3>
      <div class="input-container">
        <input type="text" id="noteInput" placeholder="Write a note...">
        <button onclick="addNote()">Add Note</button>
      </div>
      <ul id="notesList"></ul>
      <div class="section-footer">
        <button onclick="clearAll('notes')">Clear</button>
      </div>
    </div>

    <div class="section">
      <h3>Topics to Talk About</h3>
      <div class="input-container">
        <input type="text" id="topicInput" placeholder="Add a topic...">
        <button onclick="addTopic()">Add Topic</button>
      </div>
      <ul id="topicsList"></ul>
      <div class="section-footer">
        <button onclick="clearAll('topics')">Clear</button>
      </div>
    </div>

    <div class="section">
      <h3>To-Do List</h3>
      <div class="input-container">
        <input type="text" id="todoInput" placeholder="Suggest an activity...">
        <button onclick="addTodo()">Add Request</button>
      </div>
      <h4>Approved Activities</h4>
      <ul id="approvedList"></ul>
      <h4>Pending Requests</h4>
      <ul id="pendingList"></ul>
      <div class="section-footer">
        <button onclick="clearAll('todos')">Clear</button>
      </div>
    </div>

    <div id="settingsModal" class="modal">
      <div class="modal-content">
        <h3>Change Names</h3>
        <label for="khaled-name-input">His name:</label>
        <input type="text" id="khaled-name-input">
        <label for="manna-name-input">Her name:</label>
        <input type="text" id="manna-name-input">
        <div class="modal-buttons">
          <button class="delete-account-btn" onclick="deleteAccount()">Delete Account</button>
          <div class="right">
            <button onclick="saveNames()">Save</button>
            <button onclick="document.getElementById('settingsModal').style.display='none'">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <div id="themesModal" class="modal">
      <div class="modal-content">
        <h3>Choose Theme</h3>
        <div style="display: flex; flex-direction: column; gap: 10px;">
          <button onclick="changeTheme('classic')">Classic</button>
          <button onclick="changeTheme('midnight')">Midnight</button>
          <button onclick="changeTheme('sunset')">Sunset</button>
          <button onclick="changeTheme('forest')">Forest</button>
        </div>
        <div style="text-align: right; margin-top: 15px;">
          <button onclick="document.getElementById('themesModal').style.display='none'">Close</button>
        </div>
      </div>
    </div>

    <div class="section" style="text-align: center; margin-top: 40px; border: 2px solid #555;">
        <h3>Superhero-Inspired Themes</h3>
        <p>A collection of exclusive themes for our most dedicated users.</p>
        <div style="display: flex; justify-content: space-around; gap: 10px;">
            <button onclick="changeTheme('batman-signal')">Batman ü¶á</button>
            <button onclick="changeTheme('spiderman')">Spider-Man üï∑Ô∏è</button>
            <button onclick="changeTheme('hulk')">Hulk üßü</button>
            <button onclick="changeTheme('wolverine')">Wolverine ‚öîÔ∏è</button>
        </div>
    </div>
  </div>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/love-tank/sw.js')
          .then(reg => console.log('Service Worker registered.'))
          .catch(err => console.error('Service Worker registration failed:', err));
      });
    }
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signOut, deleteUser, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { 
      getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, 
      collection, addDoc, deleteDoc, getDocs, runTransaction 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAOAFu7LNRAMTUVnYkFxdO0oBPl01fF5wE",
      authDomain: "love-tank-e2af0.firebaseapp.com",
      projectId: "love-tank-e2af0",
      storageBucket: "love-tank-e2af0.firebasestorage.app",
      messagingSenderId: "935253095562",
      appId: "1:935253095562:web:0fe378a02b84d6bf936973"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- Load Saved Theme on startup ---
    const loadSavedTheme = () => {
      const savedTheme = localStorage.getItem('selectedTheme');
      if (savedTheme) {
        document.documentElement.className = `theme-${savedTheme}`;
      }
    };
    loadSavedTheme();
    
    const loadingElement = document.getElementById('loading');
    const loginPage = document.getElementById('login-page');
    const mainApp = document.getElementById('main-app');
    
    let userUID;
    
    // --- Page and UI Control ---
    const togglePageVisibility = (page) => {
        loadingElement.style.display = 'none';
        if (page === 'login') {
            loginPage.style.display = 'block';
            mainApp.style.display = 'none';
        } else if (page === 'main') {
            loginPage.style.display = 'none';
            mainApp.style.display = 'block';
        }
    };
    
    // --- Authentication Check and Data Loading ---
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        userUID = user.uid;
        console.log("User logged in:", userUID);
        togglePageVisibility('main');
        setupDataListeners();
      } else {
        console.log("No user logged in, showing login page.");
        togglePageVisibility('login');
      }
    });

    // --- Login and Signup Functions ---
    const getEmail = (username) => `${username}@couple-app.com`;

    window.signUp = async () => {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      if (!username || !password) {
        alert("Please enter a username and password.");
        return;
      }
      try {
        await createUserWithEmailAndPassword(auth, getEmail(username), password);
        alert("Account created successfully! You are now logged in.");
      } catch (error) {
        if (error.code === 'auth/email-already-in-use') {
          alert("This username is already taken. Please try logging in or choose a different one.");
        } else {
          alert(`Error signing up: ${error.message}`);
        }
        console.error("Error signing up:", error);
      }
    };

    window.logIn = async () => {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      if (!username || !password) {
        alert("Please enter a username and password.");
        return;
      }
      try {
        await signInWithEmailAndPassword(auth, getEmail(username), password);
        alert("Logged in successfully!");
      } catch (error) {
        alert(`Error logging in: ${error.message}`);
        console.error("Error logging in:", error);
      }
    };

    // --- Main Application Functions ---
    const setupDataListeners = () => {
      // --- Names Listener ---
      onSnapshot(doc(db, "users", userUID, "settings", "user-names"), (docSnap) => {
        const khaledNameDisplay = document.getElementById('khaled-name-display');
        const mannaNameDisplay = document.getElementById('manna-name-display');
        const khaledTankHeading = document.getElementById('khaled-tank-heading');
        const mannaTankHeading = document.getElementById('manna-tank-heading');
        
        if (docSnap.exists()) {
          const names = docSnap.data();
          khaledNameDisplay.textContent = names.khaled || "His";
          mannaNameDisplay.textContent = names.manna || "Her";
          khaledTankHeading.textContent = `${names.khaled || "His"}'s Tank`;
          mannaTankHeading.textContent = `${names.manna || "Her"}'s Tank`;
        } else {
          khaledNameDisplay.textContent = "His";
          mannaNameDisplay.textContent = "Her";
          khaledTankHeading.textContent = "His Tank";
          mannaTankHeading.textContent = "Her Tank";
        }
      });

      // --- Tanks Listener ---
      onSnapshot(doc(db, "users", userUID, "tanks", "levels"), (docSnap) => {
        if (docSnap.exists()) {
          const data = docSnap.data();
          document.getElementById("khaled-fill").style.width = (data.khaled || 0) + "%";
          document.getElementById("manna-fill").style.width = (data.manna || 0) + "%";
        }
      });
      
      // --- Notes Listener ---
      onSnapshot(collection(db, "users", userUID, "notes"), (snapshot) => {
        const notes = [];
        snapshot.forEach(docSnap => notes.push({ id: docSnap.id, ...docSnap.data() }));
        notes.sort((a, b) => b.createdAt?.toDate() - a.createdAt?.toDate());

        const list = document.getElementById("notesList");
        list.innerHTML = "";
        
        notes.forEach(note => {
          const date = note.createdAt?.toDate().toLocaleString("en-US", { dateStyle: "medium", timeStyle: "short" });
          const li = document.createElement("li");
          
          const content = document.createElement("span");
          content.innerHTML = `${note.text} <small>${date}</small>`;
          
          const actions = document.createElement("div");
          actions.classList.add("actions");
          
          const heartButton = document.createElement("button");
          heartButton.innerHTML = note.liked ? "‚ù§Ô∏è" : "ü§ç";
          if (note.liked) {
            heartButton.classList.add('liked');
          }
          heartButton.onclick = async () => {
            await updateDoc(doc(db, "users", userUID, "notes", note.id), { liked: !note.liked });
          };

          const deleteButton = document.createElement("button");
          deleteButton.innerHTML = "‚úñ";
          deleteButton.onclick = () => deleteItem("notes", note.id);
          
          actions.appendChild(heartButton);
          actions.appendChild(deleteButton);
          li.appendChild(content);
          li.appendChild(actions);
          list.appendChild(li);
        });
      });

      // --- Topics Listener ---
      onSnapshot(collection(db, "users", userUID, "topics"), (snapshot) => {
        const topics = [];
        snapshot.forEach(docSnap => topics.push({ id: docSnap.id, ...docSnap.data() }));
        
        const list = document.getElementById("topicsList");
        list.innerHTML = "";
        topics.forEach(topic => {
          const li = createCheckboxItem(topic.id, topic.text, topic.done, "topics");
          
          const deleteButton = document.createElement("button");
          deleteButton.innerHTML = "‚úñ";
          deleteButton.onclick = () => deleteItem("topics", topic.id);
          
          const actions = document.createElement("div");
          actions.classList.add("actions");
          actions.appendChild(deleteButton);
          
          li.appendChild(actions);
          list.appendChild(li);
        });
      });

      // --- To-Do List Listener ---
      onSnapshot(collection(db, "users", userUID, "todos"), (snapshot) => {
        const pendingList = document.getElementById("pendingList");
        const approvedList = document.getElementById("approvedList");
        pendingList.innerHTML = "";
        approvedList.innerHTML = "";
        
        const allTodos = [];
        snapshot.forEach(docSnap => allTodos.push({ id: docSnap.id, ...docSnap.data() }));

        const pendingItems = allTodos.filter(item => item.status === "pending");
        const approvedItems = allTodos.filter(item => item.status === "approved");

        // Sort approved items: unchecked first
        approvedItems.sort((a, b) => (a.done === b.done) ? 0 : a.done ? 1 : -1);

        pendingItems.forEach(item => {
          const li = document.createElement("li");
          li.textContent = item.text;
          
          const actions = document.createElement("div");
          actions.classList.add("actions");
          
          const approveBtn = document.createElement("button");
          approveBtn.textContent = "‚úî";
          approveBtn.onclick = async () => await updateDoc(doc(db, "users", userUID, "todos", item.id), { status: "approved" });
          
          const declineBtn = document.createElement("button");
          declineBtn.textContent = "‚úñ";
          declineBtn.onclick = async () => await deleteDoc(doc(db, "users", userUID, "todos", item.id));

          actions.appendChild(approveBtn);
          actions.appendChild(declineBtn);
          li.appendChild(actions);
          pendingList.appendChild(li);
        });
        
        approvedItems.forEach(item => {
          const li = createCheckboxItem(item.id, item.text, item.done, "todos");

          const deleteButton = document.createElement("button");
          deleteButton.innerHTML = "‚úñ";
          deleteButton.onclick = () => deleteItem("todos", item.id);
          
          const actions = document.createElement("div");
          actions.classList.add("actions");
          actions.appendChild(deleteButton);
          
          li.appendChild(actions);
          approvedList.appendChild(li);
        });
      });
    };

    // --- Utility Functions (Modified for User-Specific Data) ---
    const createCheckboxItem = (id, text, isDone, collectionName) => {
      const li = document.createElement("li");

      const checkboxContainer = document.createElement("div");
      checkboxContainer.classList.add('checkbox-item');

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.checked = isDone;

      const span = document.createElement("span");
      span.textContent = text;
      if (isDone) {
        span.classList.add('done');
      }

      checkbox.onchange = async () => {
        const docRef = doc(db, "users", userUID, collectionName, id);
        await updateDoc(docRef, { done: checkbox.checked });
      };

      checkboxContainer.appendChild(checkbox);
      checkboxContainer.appendChild(span);
      li.appendChild(checkboxContainer);
      return li;
    };
    
    const deleteItem = async (collectionName, id) => {
      await deleteDoc(doc(db, "users", userUID, collectionName, id));
    };

    window.clearAll = async (collectionName) => {
      if (!confirm(`Are you sure you want to clear all items? This cannot be undone.`)) {
        return;
      }
      const querySnapshot = await getDocs(collection(db, "users", userUID, collectionName));
      querySnapshot.forEach(async (document) => {
        await deleteDoc(doc(db, "users", userUID, collectionName, document.id));
      });
    };

    // --- Page-Specific Functions ---
    window.openSettings = async () => {
      const docSnap = await getDoc(doc(db, "users", userUID, "settings", "user-names"));
      if (docSnap.exists()) {
        const names = docSnap.data();
        document.getElementById('khaled-name-input').value = names.khaled || "";
        document.getElementById('manna-name-input').value = names.manna || "";
      } else {
        document.getElementById('khaled-name-input').value = "";
        document.getElementById('manna-name-input').value = "";
      }
      document.getElementById('settingsModal').style.display = 'block';
    };

    window.saveNames = async () => {
      const khaledName = document.getElementById('khaled-name-input').value || "His Name";
      const mannaName = document.getElementById('manna-name-input').value || "Her Name";
      
      const ref = doc(db, "users", userUID, "settings", "user-names");
      await setDoc(ref, {
        khaled: khaledName,
        manna: mannaName
      }, { merge: true });

      document.getElementById('settingsModal').style.display = 'none';
    };

    window.deleteAccount = async () => {
      const confirmation = confirm("Are you sure you want to permanently delete your account and all data? This cannot be undone.");
      if (confirmation) {
        try {
          const user = auth.currentUser;
          if (!user) {
            alert("No user is currently logged in.");
            return;
          }

          await runTransaction(db, async (transaction) => {
            transaction.delete(doc(db, "users", userUID, "settings", "user-names"));
            transaction.delete(doc(db, "users", userUID, "tanks", "levels"));

            const collectionsToDelete = ["notes", "topics", "todos"];
            for (const collectionName of collectionsToDelete) {
              const querySnapshot = await getDocs(collection(db, "users", userUID, collectionName));
              querySnapshot.forEach((document) => {
                transaction.delete(doc(db, "users", userUID, collectionName, document.id));
              });
            }
          });
          
          await deleteUser(user);

          alert("Your account and all data have been deleted.");
        } catch (error) {
          console.error("Error deleting account:", error);
          alert("An error occurred while deleting the account. Please try again.");
        }
      }
    };
    
    window.logOut = async () => {
      try {
        await signOut(auth);
        alert("Logged out successfully.");
      } catch (error) {
        console.error("Error logging out:", error);
        alert("An error occurred while logging out.");
      }
    };

    window.openThemes = () => {
      document.getElementById('themesModal').style.display = 'block';
    };

    window.changeTheme = (themeName) => {
      const root = document.documentElement;
      root.className = `theme-${themeName}`;
      localStorage.setItem('selectedTheme', themeName);
      document.getElementById('themesModal').style.display = 'none';
    };

    window.updateTank = async (person, change) => {
      if (!userUID) return;
      const ref = doc(db, "users", userUID, "tanks", "levels");
      
      try {
        const snap = await getDoc(ref);
        let currentKhaled = 0;
        let currentManna = 0;

        if (snap.exists()) {
          const data = snap.data();
          currentKhaled = data.khaled || 0;
          currentManna = data.manna || 0;
        }

        let newKhaled = Math.max(0, Math.min(100, currentKhaled + change));
        let newManna = Math.max(0, Math.min(100, currentManna + change));

        if (person === 'khaled') {
          newKhaled = Math.max(0, Math.min(100, currentKhaled + change));
        } else if (person === 'manna') {
          newManna = Math.max(0, Math.min(100, currentManna + change));
        }

        await setDoc(ref, {
          khaled: newKhaled,
          manna: newManna
        });
      } catch (err) {
          console.error("Error updating tank:", err);
      }
    };

    window.addNote = async () => {
      if (!userUID) return;
      const input = document.getElementById("noteInput");
      const text = input.value.trim();
      if (!text) return;
      await addDoc(collection(db, "users", userUID, "notes"), { text, createdAt: new Date() });
      input.value = "";
    };

    window.addTopic = async () => {
      if (!userUID) return;
      const input = document.getElementById("topicInput");
      const text = input.value.trim();
      if (!text) return;
      await addDoc(collection(db, "users", userUID, "topics"), { text, done: false });
      input.value = "";
    };

    window.addTodo = async () => {
      if (!userUID) return;
      const input = document.getElementById("todoInput");
      const text = input.value.trim();
      if (!text) return;
      await addDoc(collection(db, "users", userUID, "todos"), { text, status: "pending", done: false });
      input.value = "";
    };
  </script>
</body>
</html>
